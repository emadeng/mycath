<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>ØºØ±ÙØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</title>
<style>
body{font-family:Segoe UI;background:#f2f2f2;margin:0}
.container{max-width:1000px;margin:20px auto;background:#fff;padding:15px;border-radius:10px}
#main{display:flex;height:500px;gap:10px}

#messagesBox{flex:2;display:flex;flex-direction:column;border:1px solid #ccc;border-radius:8px}
#messages{flex:1;overflow:auto;padding:10px}
#send{display:flex;border-top:1px solid #ccc}
#msg{flex:1;padding:6px;border:none}
button{padding:6px 12px}
#sendBtn{ padding:6px 12px; border:none; border-radius:6px; background:#007bff; color:white; cursor:pointer; }
#butexit:hover, #sendBtn:hover{ background:#0056b3; }
#butexit { padding:6px 12px; border:none; border-radius:6px; background:red; color:white; cursor:pointer; }

#usersBox{width:250px;border:1px solid #ccc;border-radius:8px;padding:6px}
#users div{padding:4px;border-radius:4px;cursor:pointer}
#users div:hover{background:#e3f2fd}
.sys{color:#888;font-size:0.85em}

.room-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:linear-gradient(135deg,#1e88e5,#1565c0);
  color:#fff;
  padding:10px 16px;
  border-radius:10px;
  box-shadow:0 4px 10px rgba(0,0,0,0.15);
  margin-bottom:10px;
}

.room-info{
  display:flex;
  align-items:center;
  gap:10px;
}

.room-icon{
  font-size:28px;
}

.room-title{
  font-size:12px;
  opacity:0.85;
}

.room-name{
  font-size:18px;
  font-weight:bold;
}

#butexit{
  background:#e53935;
  border:none;
  color:white;
  padding:6px 14px;
  border-radius:20px;
  cursor:pointer;
  font-weight:bold;
  transition:0.3s;
}

#butexit:hover{
  background:#c62828;
}

</style>
</head>
<body>

<div class="container">
<div class="room-header">
  <div class="room-info">
    <span class="room-icon">ğŸ’¬</span>
    <div>
      <div class="room-title">Ø§Ù„ØºØ±ÙØ©</div>
      <div class="room-name" id="roomName"></div>
    </div>
  </div>

  <button onclick="leave()" id="butexit">ğŸšª Ø®Ø±ÙˆØ¬</button>
</div>

<div id="main">
  <div id="messagesBox">
    <div id="messages"></div>
    <div id="send">
      <input id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
      <button onclick="sendMsg()" id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button>
      <button id="micBtn">ğŸ”Š ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§ÙŠÙƒ</button>
    </div>
  </div>

  <div id="usersBox">
    <b>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</b>
    <div id="users"></div>

  </div>
</div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const username = sessionStorage.getItem('myUsername');
const room = sessionStorage.getItem('joinRoom');
if(!username || !room) location.href='rooms.html';

document.getElementById('roomName').textContent = room;

const socket = io('/', { auth:{ username } });

const messages = document.getElementById('messages');
const users = document.getElementById('users');

//socket.emit('join_room',{ roomId: room });
let joined = false;

socket.on('connect', ()=>{
  if(!joined){
    socket.emit('join_room',{ roomId: room });
    joined = true;
  }
});

socket.on('room_joined', data=>{
  users.innerHTML='';
  data.members.forEach(u=>{
    addUser(u.socketId,u.username);
  });
  sys('Ø¯Ø®Ù„Øª Ø§Ù„ØºØ±ÙØ©');
});

socket.on('user_joined', u=>{
  addUser(u.userId,u.username);
  sys(u.username+' Ø¯Ø®Ù„');
});

/*socket.on('user_left', u=>{
  removeUser(u.userId);
  sys(u.username+' Ø®Ø±Ø¬');
});*/
socket.on('user_left', u=>{
  if(u.userId === socket.id) return; // ØªØ¬Ø§Ù‡Ù„ Ù†ÙØ³ÙŠ
  removeUser(u.userId);
  sys(u.username+' Ø®Ø±Ø¬');
});


socket.on('new_message', m=>{
  msg(m.senderName,m.text);
});

socket.on('private_message', m=>{
  msg('(Ø®Ø§Øµ) '+m.fromName,m.text,'#d63384');
});

function msg(sender,text,color){
  const d=document.createElement('div');
  d.textContent=sender+': '+text;
  if(color) d.style.color=color;
  messages.appendChild(d);
  messages.scrollTop=messages.scrollHeight;
}

function sys(text){
  const d=document.createElement('div');
  d.textContent=text;
  d.className='sys';
  messages.appendChild(d);
}

function addUser(id,name){
  if(document.getElementById('u_'+id)) return;
  const d=document.createElement('div');
  d.id='u_'+id;
  d.textContent=name;
  d.onclick=()=>{
    const t=prompt('Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ© Ù„Ù€ '+name);
    if(t) socket.emit('private_message',{toSocketId:id,text:t});
  };
  users.appendChild(d);
}

function removeUser(id){
  const d=document.getElementById('u_'+id);
  if(d) d.remove();
}

function sendMsg(){
  const t=document.getElementById('msg').value.trim();
  if(!t) return;
  socket.emit('send_message',{ roomId:room, text:t });
  document.getElementById('msg').value='';
}
document.getElementById('msg').addEventListener('keydown',(e)=>{ if(e.key==='Enter') sendMsg(); });
function leave(){
 // socket.emit('leave_room',{ roomId:room });
  socket.disconnect();
  location.href='rooms.html';
}
</script>
</body>
</html>
