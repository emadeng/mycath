<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8"/>
<title>Ø¯Ø±Ø¯Ø´Ø© Ø´Ø¨ÙŠÙ‡Ø© Ø¨Ù€ Paltalk (MVP) - Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù†Ø©</title>
<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; background:#f4f6f8; }
  .container { max-width: 1000px; height:500px; margin: 20px auto; background:#fff; border-radius:12px; padding:20px; box-shadow:0 4px 15px rgba(0,0,0,0.1); }
  h2 { text-align:center; color:#333; }
  
  /* ÙˆØ§Ø¬Ù‡Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
  #login { display:flex; flex-direction:column; align-items:center; gap:12px; margin-top:20px; }
  #login input { padding:8px; width:200px; border-radius:6px; border:1px solid #ccc; }
  #login button { padding:8px 16px; border:none; border-radius:6px; background:#007bff; color:white; cursor:pointer; transition:0.3s; }
  #login button:hover { background:#0056b3; }

  /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
  #chat { display:none; margin-top:12px; }
  #chat-controls { display:flex; gap:12px; margin-bottom:12px; }
  #chat-controls input { padding:6px; border-radius:6px; border:1px solid #ccc; flex:1; }
  #chat-controls button { padding:6px 12px; border:none; border-radius:6px; background:#28a745; color:white; cursor:pointer; }
  #chat-controls button:hover { background:#1e7e34; }

  #main { display:flex; gap:12px; }
  #messages { flex:2; height:350px; overflow:auto; border:1px solid #ccc; padding:10px; border-radius:8px; background:#fdfdfd; }
  #users-panel { width:250px; display:flex; flex-direction:column; gap:12px; }

  #users, #all-users { height:250px; overflow:auto; border:1px solid #ddd; border-radius:6px; padding:6px; background:#fafafa; }
  #users div, #all-users div { padding:4px 6px; cursor:pointer; border-radius:4px; }
  #users div:hover, #all-users div:hover { background:#e1f5fe; }

  .sys { color:#888; font-size:0.85em; font-style:italic; margin-bottom:4px; }

  #msg-input { display:flex; margin-top:8px; gap:6px; }
  #msg { flex:1; padding:6px; border-radius:6px; border:1px solid #ccc; }
  #sendBtn { padding:6px 12px; border:none; border-radius:6px; background:#007bff; color:white; cursor:pointer; }
  #sendBtn:hover { background:#0056b3; }
</style>
</head>
<body>
<div class="container">
  <h2>ØªØ¬Ø±Ø¨Ø© Ø¯Ø±Ø¯Ø´Ø© Ø´Ø¨ÙŠÙ‡Ø© Ø¨Ù€ Paltalk - Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù†Ø©</h2>

  <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="login">
    <input id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"/>
    <input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"/>
    <button id="loginBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <p>Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <button id="signupBtn">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button></p>
  </div>
<div id="signup" style="display:none;">
  <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
  <input id="newUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" />
  <input id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
  <input id="newPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
  <select id="gender">
    <option value="male">Ø°ÙƒØ±</option>
    <option value="female">Ø£Ù†Ø«Ù‰</option>
  </select>
  <input id="avatar" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø£ÙØªØ§Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
  <button id="createAccountBtn">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
  <button id="backToLoginBtn">Ø±Ø¬ÙˆØ¹</button>
</div>
  <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
  <div id="chat">
  <div id="roomControls" style="display:none; margin-bottom:8px;">
      <strong>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØºØ±ÙØ© ğŸ‘‘</strong><br>
      <button id="lockRoomBtn">ğŸ”’ Ù‚ÙÙ„ Ø§Ù„ØºØ±ÙØ©</button>
      <button id="unlockRoomBtn">ğŸ”“ ÙØªØ­ Ø§Ù„ØºØ±ÙØ©</button>
    </div>
    <div id="chat-controls">
      <input id="room" placeholder="Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ© (Ù…Ø«Ø§Ù„: lobby)"/>
      <button id="createBtn">Ø§Ù†Ø´Ø¦ ØºØ±ÙØ©</button>
      <button id="joinBtn">Ø§Ù†Ø¶Ù… Ù„Ù„ØºØ±ÙØ©</button>
      <!-- Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ Ø³ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… -->
<button id="leaveBtn" style="display:none; background:#dc3545;">Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØºØ±ÙØ©</button>

    </div>

    <div id="main">
      <div style="flex:2; display:flex; flex-direction:column;">
        <div id="messages"></div>
        <div id="msg-input">
          <input id="msg" placeholder="Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©"/>
          <button id="sendBtn">Ø£Ø±Ø³Ù„</button>
        </div>
      </div>

      <div id="users-panel">
        <h4>Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙÙŠ Ø§Ù„ØºØ±ÙØ©</h4>
        <div id="users"></div>

      <!--  <h4>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h4>
        <div id="all-users"></div>-->
      </div>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
let socket; // Ù…ØªØºÙŠØ± Ø¹Ø§Ù„Ù…ÙŠ
let myUsername;
let currentRoom = null;
let roomOwner = null;
// Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
document.getElementById('signupBtn').onclick = () => {
  document.getElementById('login').style.display = 'none';
  document.getElementById('signup').style.display = 'block';
};

document.getElementById('backToLoginBtn').onclick = () => {
  document.getElementById('signup').style.display = 'none';
  document.getElementById('login').style.display = 'block';
};

// Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
document.getElementById('createAccountBtn').onclick = async () => {
  const username = document.getElementById('newUsername').value.trim();
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('newPassword').value.trim();
  const gender = document.getElementById('gender').value;
  const avatar = document.getElementById('avatar').value.trim();

  if (!username || !email || !password) return alert('Ø£Ø¯Ø®Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

  const res = await fetch('/create-user', {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({ username, email, password, gender, avatar })
  });
  const data = await res.json();

  if (data.success) {
    alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨! ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
    document.getElementById('signup').style.display = 'none';
    document.getElementById('login').style.display = 'block';
  } else {
    alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ù‹Ø§');
  }
};

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
document.getElementById('loginBtn').onclick = async () => {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();
  if (!username || !password) return alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');

  try {
    const res = await fetch('/login', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ username, password })
    });
    const data = await res.json();

    if (!data.success) return alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');

    myUsername = data.user.username;

    // Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø©
    sessionStorage.setItem('myUsername', myUsername);

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø³ÙŠØ±ÙØ± Socket.IO
    socket = io('/', { auth: { username: myUsername } });

    // Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„
    socket.on('connect', () => {
      document.getElementById('login').style.display = 'none';
      document.getElementById('chat').style.display = 'block';
      addSys('Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… (id=' + socket.id + ')');
    });

    // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ© Ù…Ø¹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
    socket.on('room_joined', (data) => {
      addSys('Ø§Ù†Ø¶Ù…Ù…Øª Ø§Ù„ØºØ±ÙØ© ' + data.roomId);
	  const room = document.getElementById('room').value;
messagesEl.innerHTML = `${myUsername} Ø§Ù‡Ù„Ø§ Ùˆ Ø³Ù‡Ù„Ø§ Ø¨Ùƒ ÙÙŠ Ø§Ù„ØºØ±ÙØ© ${room}`;

      usersEl.innerHTML = '';

      if (data.members && data.members.length) {
        data.members.forEach(u => addUser(u.userId, u.username));
      }
    });

 socket.on('room_locked', () => addSys('ğŸ”’ ØªÙ… Ù‚ÙÙ„ Ø§Ù„ØºØ±ÙØ©'));
    socket.on('room_unlocked', () => addSys('ğŸ”“ ØªÙ… ÙØªØ­ Ø§Ù„ØºØ±ÙØ©'));
    socket.on('kicked', () => { alert('ØªÙ… Ø·Ø±Ø¯Ùƒ Ù…Ù† Ø§Ù„ØºØ±ÙØ©'); leaveBtn.click(); });
	
    socket.on('user_joined', (u) => {
      addSys(u.username + ' Ø¯Ø®Ù„ Ø§Ù„ØºØ±ÙØ©');
      addUser(u.userId, u.username);
    });

    socket.on('user_left', (u) => {
      addSys(u.username + ' ØºØ§Ø¯Ø± Ø§Ù„ØºØ±ÙØ©');
      removeUser(u.userId);
    });

    socket.on('new_message', (m) => {
      addMsg(m.senderName || m.senderId, m.text);
    });

    socket.on('private_message', (m) => {
      const sender = m.fromId === socket.id
        ? `${myUsername} (Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ©)`
        : `${m.fromName} (Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ© Ù…Ù†)`;

      const d = document.createElement('div');
      d.textContent = `${sender}: ${m.text}`;
      d.style.color = '#d63384';
      d.style.fontStyle = 'italic';
      messagesEl.appendChild(d);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });

  } catch (err) {
    console.error(err);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
  }
};
const createBtn = document.getElementById('createBtn');
const joinBtn = document.getElementById('joinBtn');
const leaveBtn = document.getElementById('leaveBtn');

// Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©
document.getElementById('joinBtn').onclick = () => {
  const room = document.getElementById('room').value;
  if (!room) return alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©');
  socket.emit('join_room', { roomId: room });

  // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…/Ø¥Ù†Ø´Ø§Ø¡
  createBtn.style.display = 'none';
  joinBtn.style.display = 'none';

  // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬
  leaveBtn.style.display = 'inline-block';
};

// Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©
document.getElementById('createBtn').onclick = () => {
  const name = document.getElementById('room').value || ('room_' + Date.now());
  socket.emit('create_room', { name });

  createBtn.style.display = 'none';
  joinBtn.style.display = 'none';
  leaveBtn.style.display = 'inline-block';
};

// Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØºØ±ÙØ©
leaveBtn.onclick = () => {
  const room = document.getElementById('room').value;
  if (!room) return;

  socket.emit('leave_room', { roomId: room });

  addSys('ØºØ§Ø¯Ø±Øª Ø§Ù„ØºØ±ÙØ© ' + room);
  
  // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…/Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ø¯Ø¯Ù‹Ø§
  createBtn.style.display = 'inline-block';
  joinBtn.style.display = 'inline-block';

  // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬
  leaveBtn.style.display = 'none';

  // Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
  messagesEl.innerHTML = '';
  usersEl.innerHTML = '';
};

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ø§Ù…Ø©
const messagesEl = document.getElementById('messages');
const usersEl = document.getElementById('users');

document.getElementById('sendBtn').onclick = sendMessage;
document.getElementById('msg').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') sendMessage();
});

function sendMessage() {
  const room = document.getElementById('room').value;
  const txt = document.getElementById('msg').value.trim();
  if (!room) return alert('Ø§Ù†Ø¶Ù… Ù„ØºØ±ÙØ© Ø£ÙˆÙ„Ø§Ù‹');
  if (!txt) return;
  socket.emit('send_message', { roomId: room, text: txt });
  document.getElementById('msg').value = '';
}

// Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ù…Ø©
function addMsg(sender, text) {
  const d = document.createElement('div');
  d.textContent = sender + ': ' + text;
  messagesEl.appendChild(d);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ù†Ø¸Ø§Ù…
function addSys(text) {
  const d = document.createElement('div');
  d.textContent = text;
  d.className = 'sys';
  messagesEl.appendChild(d);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
function addUser(id, name) {
  const el = document.createElement('div');
  el.id = 'user_' + id;
  el.textContent = name + ' (' + id.slice(0,6) + ')';
  el.style.cursor = 'pointer';
  el.style.padding = '4px 6px';
  el.style.borderRadius = '4px';
  el.onmouseover = () => el.style.background = '#e1f5fe';
  el.onmouseout = () => el.style.background = '';
  el.onclick = () => {
    const text = prompt('Ø£Ø¯Ø®Ù„ Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ© Ø¥Ù„Ù‰ ' + name);
    if (text) socket.emit('private_message', { toSocketId: id, text });
  };
  usersEl.appendChild(el);
}

// Ø¥Ø²Ø§Ù„Ø© Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
function removeUser(id) {
  const el = document.getElementById('user_' + id);
  if (el) el.remove();
}

</script>
</body>
</html>
