<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>ØºØ±ÙØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</title>
<style>
body{margin:0;font-family:'Segoe UI',sans-serif;background:#f4f6f8;}
#roomContainer{display:flex;height:100vh;flex-direction:column;}
#taskbar{background:linear-gradient(135deg,#1976d2,#0d47a1);color:#fff;padding:10px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,0.2);}
#taskbar .left-controls,#taskbar .right-controls{display:flex;align-items:center;gap:10px;}
#taskbar .room-title{font-size:18px;font-weight:bold;}
#taskbar button{background:#ffffff33;border:none;border-radius:16px;padding:6px 12px;color:#fff;cursor:pointer;font-weight:bold;transition:0.2s;}
#taskbar button:hover{background:#ffffff66;}
#taskbar .owner-controls{display:flex;align-items:center;gap:8px;}
#taskbar .owner-controls input{padding:5px 10px;border-radius:16px;border:none;outline:none;}
#roomContent{display:flex;flex:1;overflow:hidden;}
#users{width:220px;background:#fff;border-left:1px solid #ddd;padding:10px;box-shadow:0 0 6px rgba(0,0,0,0.05);overflow-y:auto;}
#users div{padding:6px 8px;margin-bottom:4px;border-radius:6px;cursor:pointer;transition:0.2s;display:flex;justify-content:space-between;align-items:center;}
#users div:hover{background:#f0f0f0;}
#messagesContainer{flex:1;display:flex;flex-direction:column;padding:10px;background:#fdfdfd;overflow:hidden;}
#messages{flex:1;overflow-y:auto;padding:10px;border-radius:8px;background:#fff;border:1px solid #ccc;}
#msg-input{display:flex;gap:6px;margin-top:6px;}
#msg{flex:1;padding:6px 10px;border-radius:6px;border:1px solid #ccc;outline:none;}
#sendBtn{background:#1976d2;color:#fff;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;}
#sendBtn:hover{ background:#0d47a1; }
.sys{color:#888;font-size:0.85em;font-style:italic;margin-bottom:4px;}
.mic-status{font-size:0.9em;}
.no-click {
    pointer-events: none;
    user-select: none;
}
#messages, #users {
    user-select: none;
    -webkit-user-select: none;
}

.welcome-text {
    font-size: 16px;
    font-weight: bold;
   // background: linear-gradient(90deg, #00c6ff, #0072ff);
   // -webkit-background-clip: text;
 //   -webkit-text-fill-color: transparent;
color:#0072ff;
}

.usernamein {
   // background: linear-gradient(90deg, #f7971e, #ffd200);
    //-webkit-background-clip: text;
//    -webkit-text-fill-color: transparent;
color:#00078;
}
</style>
</head>
<body>
<div id="roomContainer">
  <div id="taskbar">
    <div class="left-controls">
      <div class="room-title">Ø§Ù„ØºØ±ÙØ©: <span id="roomName"></span></div>
      <div class="owner-controls" style="display:none;">
        <input type="text" id="roomPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button id="lockBtn">ğŸ”’ Ù‚ÙÙ„ Ø§Ù„ØºØ±ÙØ©</button>
        <button id="unlockBtn" style="display:none;">ğŸ”“ ÙØªØ­ Ø§Ù„ØºØ±ÙØ©</button>
        <button id="modsBtn">ğŸ‘‘ Ù…Ø´Ø±ÙÙŠÙ†</button>
        <button id="pinnedBtn">ğŸ“Œ ØºØ±Ù Ù…Ø«Ø¨ØªØ©</button>
       <input type="text" id="newMessage" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©">
<button onclick="addMessage()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
      </div>
    </div>
    <div class="right-controls">
      <button id="micBtn">ğŸ”Š Ù…Ø§ÙŠÙƒ</button>
      <button id="statusBtn">ğŸŸ¢ Ù…ØªØµÙ„</button>
      <button onclick="leave()">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <div id="roomContent">
    <div id="messagesContainer">
      <div id="messages"></div>
      <div id="msg-input">
        <input id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."/>
        <button id="sendBtn">Ø£Ø±Ø³Ù„</button>
      </div>
    </div>
    <div id="users"></div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const username = sessionStorage.getItem('myUsername');
const room = sessionStorage.getItem('joinRoom');
const roomPassword = sessionStorage.getItem('roomPassword') || null;
if(!username || !room) location.href='rooms.html';
document.getElementById('roomName').textContent = room;

const socket = io('/', { auth:{ username }, reconnection:false });
const messages = document.getElementById('messages');
const users = document.getElementById('users');

const ownerControls = document.querySelector('.owner-controls');
const roomPassInput = document.getElementById('roomPass');
const lockBtn = document.getElementById('lockBtn');
const unlockBtn = document.getElementById('unlockBtn');

let isOwner = false;
let micOn = true;

  // Ù…ØµÙÙˆÙØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    let messages_we = JSON.parse(localStorage.getItem("messages_we")) || [
    "Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ØºØ±ÙØªÙ†Ø§ !"
];



    // Ø¯Ø§Ù„Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø±Ø³Ø§Ù„Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
    function getRandomMessage() {
        const randomIndex = Math.floor(Math.random() * messages_we .length);
        return messages_we[randomIndex];
    }

// ----- Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„ØºØ±ÙØ© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© -----
if(!window.joinedRoom){
  socket.emit('join_room',{ roomId: room, password: roomPassword });
  window.joinedRoom = true;
}

socket.once('room_joined', data => {
  if(data.owner === username){
    isOwner = true;
    ownerControls.style.display = 'inline-flex';
    sessionStorage.setItem('owner', data.owner);

    if(data.locked){
      roomPassInput.style.display='none';
      lockBtn.style.display='none';
      unlockBtn.style.display='inline-block';
    } else {
      roomPassInput.style.display='inline-flex';
      lockBtn.style.display='inline-block';
      unlockBtn.style.display='none';
    }
  }

  users.innerHTML = '';
  data.members.forEach(u => addUser(u.socketId, u.username,u.username == data.owner ,  u.micOn));


 sys( getRandomMessage() +username);
});

socket.once('error_msg', msg => { alert(msg); location.href='rooms.html'; });

// ----- Ù…Ø³ØªØ®Ø¯Ù… Ø¯Ø®Ù„ -----

socket.on('user_joined', u => {
  // ÙÙ‚Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„ØºØ±ÙØ©
  if (u.roomId !== room) return;

  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§
  if (!document.getElementById('u_' + u.userId)) {
    addUser(u.userId, u.username, u.isOwner, u.micOn);
    sys(u.username + ' Ø¯Ø®Ù„ Ø§Ù„ØºØ±ÙØ©');
sys(`
    <span>${room}: </span>
  <span class="welcome-text">
    ${getRandomMessage()} 
    <span class="usernamein">${username}</span>
  </span>
`);

  }
});

// ----- Ù…Ø³ØªØ®Ø¯Ù… Ø®Ø±Ø¬ -----
socket.on('user_left', u => {
  if (u.roomId === room) {
  removeUser(u.userId);
  //  addUser(u.userId, u.username, u.isOwner,u.micOn);
  sys(u.username + ' Ø®Ø±Ø¬');
}else{
  removeUser(u.userId);
}
});


// ----- ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø§ÙŠÙƒ -----
socket.on('user_mic_status', ({ socketId, micOn })=>{
  const userDiv = document.getElementById('u_'+socketId);
  if(userDiv){
    const micSpan = userDiv.querySelector('.mic-status');
    if(micSpan) micSpan.textContent = micOn ? 'ğŸ”Š' : 'ğŸ”‡';
  }
});

// ----- Ø±Ø³Ø§Ø¦Ù„ -----
//socket.on('new_message', m=> msg(m.senderName,m.text));
socket.on('new_message', m => {
    msg(m.senderName, m.text, m.avatarUrl);
});

socket.on('private_message', m=> msg('(Ø®Ø§Øµ) '+m.fromName,m.text,'#d63384'));

// ----- Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… -----

function sys(text){
  const d = document.createElement('div');
  d.innerHTML = text;   // âœ… Ù‡Ù†Ø§ Ø§Ù„Ø­Ù„
  d.className = 'sys';
  messages.appendChild(d);
  messages.scrollTop = messages.scrollHeight;
}
/*
function msg(sender,text,color){
  const d=document.createElement('div');
  d.textContent = sender+': '+text;
  if(color) d.style.color=color;
  messages.appendChild(d);
  messages.scrollTop = messages.scrollHeight;
}
*/
function msg(sender, text, avatarUrl, color) {
    const d = document.createElement('div');
    d.className = 'message-item';
    d.style.display = 'flex';
    d.style.alignItems = 'center';
    d.style.marginBottom = '6px';

    // ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
    const img = document.createElement('img');
    img.src = avatarUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(sender)}&background=random&color=#fffff&rounded=true`;
    img.style.width = '42px';
    img.style.height = '42px';
    img.style.borderRadius = '50%';
    img.style.marginRight = '8px';

    // Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    const textDiv = document.createElement('div');
    textDiv.textContent = sender + ': ' + text;
    if (color) textDiv.style.color = color;

    d.appendChild(img);
    d.appendChild(textDiv);
    messages.appendChild(d);
    messages.scrollTop = messages.scrollHeight;
}

// ----- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -----
function addUser(id, name, isOwner = false, mic = true) {
  if (document.getElementById('u_' + id)) return; // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±

  const d = document.createElement('div');
  d.id = 'u_' + id;
  d.className = 'user-item';

  d.innerHTML = `
    <span class="username">${isOwner ? 'ğŸ‘‘' : 'ğŸ‘¤'} ${name}</span>
    <span class="mic-status">${mic ? 'ğŸ”Š' : 'ğŸ”‡'}</span>
  `;

  d.onclick = () => {
    if (id === socket.id) return;
    const t = prompt('Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ© Ù„Ù€ ' + name);
    if (t) socket.emit('private_message', { toSocketId: id, text: t });
  };

  users.appendChild(d);
}

function removeUser(id){ const d=document.getElementById('u_'+id); if(d) d.remove(); }

// ----- Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© -----
function sendMsg(){
  const t=document.getElementById('msg').value.trim();
  if(!t) return;
  socket.emit('send_message',{ roomId:room, text:t });
  document.getElementById('msg').value='';
}
document.getElementById('msg').addEventListener('keydown',(e)=>{ if(e.key==='Enter') sendMsg(); });
document.getElementById('sendBtn').addEventListener('click', sendMsg);

// ----- Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ© -----
function leave(){
  socket.emit('leave_room',{ roomId:room });
  socket.disconnect();
  location.href='rooms.html';
}

// ----- Owner Controls -----
lockBtn.onclick=()=>{ const pass=roomPassInput.value.trim(); if(!pass){ alert('âŒ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'); return;} socket.emit('lock_room',{roomId:room,password:pass}); roomPassInput.value=''; };
unlockBtn.onclick=()=>{ socket.emit('unlock_room',{roomId:room}); };

// ----- Ø²Ø± Ø§Ù„Ù…Ø§ÙŠÙƒ -----
document.getElementById('micBtn').onclick=()=>{
  micOn=!micOn;
  document.getElementById('micBtn').textContent=micOn?'ğŸ”Š Ù…Ø§ÙŠÙƒ':'ğŸ”‡ ØµØ§Ù…Øª';
  socket.emit('mic_status',{roomId:room,micOn});
}

// ----- Ø£Ø²Ø±Ø§Ø± Taskbar -----
document.getElementById('statusBtn').onclick=()=>alert('ğŸŸ¢ Ø£Ù†Øª Ù…ØªØµÙ„');
document.getElementById('modsBtn').onclick=()=>alert('ğŸ‘‘ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†');
document.getElementById('pinnedBtn').onclick=()=>alert('ğŸ“Œ Ø§Ù„ØºØ±Ù Ø§Ù„Ù…Ø«Ø¨ØªØ©');

 function addMessage() {
    const input = document.getElementById("newMessage");
    const newMsg = input.value.trim();

    if (newMsg !== "") {
        messages_we.push(newMsg);

        // ğŸ’¾ Ø­ÙØ¸ Ø¯Ø§Ø¦Ù…
        localStorage.setItem(
            "messages_we",
            JSON.stringify(messages_we)
        );

        alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø©!");
        input.value = "";
    } else {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø±Ø³Ø§Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©!");
    }
}

function blockLeftClick(el) {
    el.addEventListener("mousedown", function(e) {
        if (e.button === 0) { // Ø²Ø± Ø£ÙŠØ³Ø±
            e.preventDefault();
            e.stopPropagation();
            return false;
        }
    });
}
blockLeftClick(document.getElementById("users"));
blockLeftClick(document.getElementById("messages"));

</script>
</body>
</html>
